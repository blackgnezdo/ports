# OpenBSD Cabal Module

This directory contains the infrastructure for building Haskell packages using cabal-install on OpenBSD.

## Overview

The cabal module (`devel/cabal/cabal.port.mk`) provides a framework for building Haskell applications from Hackage with offline, reproducible builds.

## Quick Start for Port Maintainers

### Creating a New Cabal Port

1. Create the port directory structure:
   ```sh
   mkdir -p category/portname
   cd category/portname
   ```

2. Run cabal-bundler to generate the manifest:
   ```sh
   cabal-bundler --openbsd package-version --executable exe-name
   ```

3. Create `Makefile`:
   ```makefile
   COMMENT =       brief description

   MODCABAL_STEM =        PackageName
   MODCABAL_VERSION =     1.2.3
   CATEGORIES =           category

   # License
   PERMIT_PACKAGE =       Yes

   WANTLIB =             c ffi gmp iconv m pthread util

   MODULES =             devel/cabal

   .include "cabal-manifest.inc"

   LIB_DEPENDS =         converters/libiconv \
                        devel/gmp \
                        devel/libffi

   .include <bsd.port.mk>
   ```

4. Create `cabal-manifest.inc` from cabal-bundler output:
   ```makefile
   # Generated by: cabal-bundler --openbsd package-version --executable exe

   MODCABAL_MANIFEST += dependency1 1.0.0 0
   MODCABAL_MANIFEST += dependency2 2.0.0 1
   ...
   ```

5. Generate checksums:
   ```sh
   make makesum
   ```

6. Build and test:
   ```sh
   make package
   make install
   make test  # if available
   ```

### Updating an Existing Port

The easy way (automated):
```sh
cd /usr/ports
./devel/cabal/update-cabal-port.sh category/portname
```

The manual way:
1. Run cabal-bundler for the new version
2. Update `MODCABAL_VERSION` in Makefile
3. Update `cabal-manifest.inc` with new dependencies
4. Run `make makesum`
5. Test: `make package && make install`

## Automation Tools

### migrate-to-inc.sh

Migrates a port from inline `MODCABAL_MANIFEST` to `cabal-manifest.inc`:

```sh
./devel/cabal/migrate-to-inc.sh category/portname
```

This creates:
- `cabal-manifest.inc` - Generated manifest file
- `Makefile.bak` - Backup of original Makefile
- Updated `Makefile` - Now includes cabal-manifest.inc

### update-cabal-port.sh

Updates a single port to the latest (or specified) version:

```sh
# Update to latest version from Hackage
./devel/cabal/update-cabal-port.sh category/portname

# Update to specific version
./devel/cabal/update-cabal-port.sh category/portname --version 2.0.0

# Dry run (show what would be done)
./devel/cabal/update-cabal-port.sh category/portname --dry-run

# Update and build package
./devel/cabal/update-cabal-port.sh category/portname --package
```

Options:
- `--version <ver>` - Update to specific version (default: latest from Hackage)
- `--dry-run` - Show what would be done without making changes
- `--no-makesum` - Skip running `make makesum`
- `--package` - Run `make package` after update
- `--help` - Show help message

### update-all-cabal-ports.sh

Batch update all cabal ports:

```sh
# Dry run to see what would be updated
./devel/cabal/update-all-cabal-ports.sh --dry-run

# Update all ports
./devel/cabal/update-all-cabal-ports.sh

# Update with git commits for each port
./devel/cabal/update-all-cabal-ports.sh --git-commit

# Continue from last port (if interrupted)
./devel/cabal/update-all-cabal-ports.sh --continue
```

Options:
- `--dry-run` - Show what would be done
- `--no-makesum` - Skip checksums (not recommended)
- `--package` - Build packages (very slow!)
- `--git-commit` - Create commits for successful updates
- `--continue` - Resume from last processed port
- `--help` - Show help message

### migrate-all-ports.sh

Migrate all cabal ports to use `.inc` files:

```sh
./devel/cabal/migrate-all-ports.sh
```

## Cabal Manifest Include File Format

The `cabal-manifest.inc` file contains the dependency manifest in a clean, easy-to-regenerate format:

```makefile
# Generated by: cabal-bundler --openbsd package-version [options]

MODCABAL_MANIFEST += package1 version1 revision1
MODCABAL_MANIFEST += package2 version2 revision2
MODCABAL_MANIFEST += package3 version3 revision3
...
```

Each line adds one dependency triple:
- **package**: Hackage package name
- **version**: Package version
- **revision**: Cabal file revision number (0 if no revision)

The first line preserves the cabal-bundler command used to generate the file, ensuring reproducibility.

## Makefile Variables

### Required Variables

- `MODCABAL_STEM` - Hackage package name
- `MODCABAL_VERSION` - Package version

### Optional Variables

- `MODCABAL_MANIFEST` - Dependency manifest (usually in cabal-manifest.inc)
- `MODCABAL_EXECUTABLES` - Executable names (default: `${MODCABAL_STEM}`)
- `MODCABAL_FLAGS` - Cabal build flags
- `MODCABAL_BUILD_ARGS` - Additional cabal v2-build arguments
- `MODCABAL_REVISION` - Cabal file revision (if needed)
- `MODCABAL_DATA_DIR` - Data directory (if package uses data files)

### Example: Port with Multiple Executables

```makefile
MODCABAL_STEM =         pandoc-cli
MODCABAL_VERSION =      3.8.3
MODCABAL_EXECUTABLES =  pandoc pandoc-server

# In cabal-bundler:
# cabal-bundler --openbsd pandoc-cli-3.8.3 --executable pandoc --executable pandoc-server
```

### Example: Port with Build Flags

```makefile
MODCABAL_STEM =         darcs
MODCABAL_VERSION =      2.18.5
MODCABAL_FLAGS =        curl -library

# In cabal-bundler:
# cabal-bundler --openbsd darcs-2.18.5 --flags "curl -library"
```

## Workflow for Updating Multiple Ports

### Scenario: Update all ports, validate locally

1. **Create a working branch:**
   ```sh
   cd /usr/ports
   git checkout -b update-cabal-ports-$(date +%Y%m%d)
   ```

2. **Run the batch updater:**
   ```sh
   ./devel/cabal/update-all-cabal-ports.sh --git-commit
   ```

3. **Review changes:**
   ```sh
   git log --oneline
   git show HEAD  # review most recent update
   ```

4. **Test each updated port:**
   ```sh
   cd category/portname
   make clean
   make package
   make install
   # Test the installed software
   ```

5. **Handle failures:**
   - Review error messages
   - Fix patches manually if they don't apply
   - Update PLIST if files changed
   - Adjust build flags if needed
   - Commit fixes: `git commit -am "Fix port after update"`

6. **Push when satisfied:**
   ```sh
   git push origin update-cabal-ports-$(date +%Y%m%d)
   ```

## Handling Complex Cases

### Patches Don't Apply

When updating a port, existing patches may fail to apply:

1. Update the port to get new sources:
   ```sh
   ./devel/cabal/update-cabal-port.sh category/portname
   make clean
   ```

2. Try to build to see which patches fail:
   ```sh
   make patch  # will fail on problematic patches
   ```

3. Fix patches manually:
   ```sh
   cd /usr/ports/category/portname
   # Edit patches/patch-* files to match new source
   # Or regenerate patches if the change is no longer needed
   ```

4. Test the fix:
   ```sh
   make clean
   make package
   ```

### PLIST Changes

If the package adds/removes files:

1. Build and install:
   ```sh
   make package
   make install
   ```

2. Generate new PLIST:
   ```sh
   make update-plist
   ```

3. Review changes:
   ```sh
   git diff pkg/PLIST
   ```

4. Commit:
   ```sh
   git add pkg/PLIST
   git commit -m "Update PLIST for new version"
   ```

### Complex cabal-bundler Commands

Some ports need special cabal-bundler flags. These are preserved in the cabal-manifest.inc comment:

```makefile
# Generated by: cabal-bundler --openbsd package-2.0 --executable exe1 --executable exe2 --flags "flag1 -flag2"
```

To regenerate manually:
```sh
cabal-bundler --openbsd package-2.0 --executable exe1 --executable exe2 --flags "flag1 -flag2"
```

## Technical Details

### Offline Builds

The cabal module uses offline builds:
1. All dependencies are downloaded as distfiles
2. `cabal.project.local` references local package directories
3. `cabal v2-build --offline` ensures no network access during build

### Build Process

1. **post-extract**: Set up `.cabal/config` and `cabal.project.local`
2. **do-build**: Run `cabal v2-build --offline`
3. **do-install**: Install executables to `${PREFIX}/bin`

### Data Directory Support

If a package uses `data-dir`, set `MODCABAL_DATA_DIR`:

```makefile
MODCABAL_DATA_DIR = share/package-name
```

This creates wrapper scripts that set up the environment before running executables.

## Migration from Old Format

Old format (inline manifest in Makefile):
```makefile
MODCABAL_MANIFEST = \
    package1 version1 revision1 \
    package2 version2 revision2 \
    ...
```

New format (separate include file):
```makefile
.include "cabal-manifest.inc"
```

To migrate, run:
```sh
./devel/cabal/migrate-to-inc.sh category/portname
```

The module supports both formats for backward compatibility.

## Getting Help

- OpenBSD Ports Mailing List: ports@openbsd.org
- Cabal Documentation: https://cabal.readthedocs.io/
- Hackage: https://hackage.haskell.org/

## See Also

- `devel/cargo/cargo.port.mk` - Similar pattern for Rust ports
- `lang/go/go.port.mk` - Similar pattern for Go ports
- `cabal-bundler(1)` - Generate manifests for OpenBSD ports
