# OpenBSD Cabal Ports Automation Plan

## Goal
Automate updating OpenBSD ports that use `MODULES=devel/cabal` to the latest Hackage versions, with local validation capability.

## Current State Analysis

### Existing Cabal Ports (13 total)
1. devel/alex
2. devel/cabal-bundler
3. devel/cpphs
4. devel/darcs
5. devel/git-annex
6. devel/happy
7. devel/hasktags
8. devel/shellcheck
9. net/matterhorn
10. productivity/hledger
11. textproc/pandoc
12. x11/xmobar
13. x11/xmonad

### Current Manual Process
1. Run `cabal-bundler --openbsd <package>-<version> [--executable <exe>]`
2. Update `MODCABAL_VERSION` and `MODCABAL_MANIFEST` in Makefile
3. Run `make makesum` to update distinfo
4. Run `make package` to build
5. Run `make install` to install
6. Handle edge cases:
   - Patches that don't apply cleanly
   - PLIST changes
   - Complex cabal-bundler invocations (recorded in Makefile comments)

### Current Limitations
- `MODCABAL_MANIFEST` is embedded directly in Makefile (makes large manifests unwieldy)
- Manual editing of Makefile required for each update
- No automated version checking against Hackage

## Proposed Solution

### Phase 1: Infrastructure Changes (Prerequisite)

#### 1.1 Create `.inc` File Format for Cabal Manifests

Adopt the cargo module pattern: use a separate `cabal-manifest.inc` file.

**Format:**
```makefile
# Generated by: cabal-bundler --openbsd package-version [args]
MODCABAL_MANIFEST += package1 version1 revision1
MODCABAL_MANIFEST += package2 version2 revision2
MODCABAL_MANIFEST += package3 version3 revision3
```

**Benefits:**
- Clean separation of generated vs manual content
- Easy to regenerate the entire file
- Preserves cabal-bundler command in comment for reproducibility
- Follows established OpenBSD ports patterns (cargo, go modules)

#### 1.2 Update `devel/cabal/cabal.port.mk`

Modify the module to support both old (inline) and new (.inc file) formats:
- If `cabal-manifest.inc` exists, include it
- Otherwise fall back to inline `MODCABAL_MANIFEST`
- This ensures backward compatibility during migration

#### 1.3 Migration Script

Create `devel/cabal/migrate-to-inc.sh`:
- Extracts MODCABAL_MANIFEST from Makefile
- Finds cabal-bundler command from comments
- Generates `cabal-manifest.inc`
- Updates Makefile to include the .inc file

### Phase 2: Automation Tools

#### 2.1 Version Checker

Script to check Hackage for latest versions:
- Query Hackage API for each cabal port
- Compare with current `MODCABAL_VERSION`
- Report available updates

#### 2.2 Update Automation Script

Create `devel/cabal/update-cabal-port.sh`:

```bash
update-cabal-port.sh <port-directory> [--dry-run] [--version <ver>]
```

Steps:
1. Parse current Makefile for MODCABAL_STEM, cabal-bundler args
2. Query Hackage for latest version (or use specified version)
3. Run cabal-bundler with appropriate flags
4. Generate new `cabal-manifest.inc`
5. Update `MODCABAL_VERSION` in Makefile
6. Run `make makesum`
7. Optionally run `make package` and `make install`
8. Report any errors (patch failures, PLIST changes, etc.)

#### 2.3 Batch Update Tool

Create `devel/cabal/update-all-cabal-ports.sh`:
- Iterates through all cabal ports
- Runs update script on each
- Generates summary report
- Creates branches/commits for successful updates

### Phase 3: Local Validation Workflow

The automation preserves local validation capability:

1. Automation creates updates in separate branch or commits
2. User can review changes:
   ```bash
   cd <port-directory>
   make makesum      # Verify checksums
   make package      # Build package
   make install      # Install locally
   make test         # Run tests if available
   ```
3. User can handle complex cases:
   - Manually fix patches that don't apply
   - Update PLIST if needed
   - Adjust build flags
4. User decides when to commit/push

## Implementation Plan

### Step 1: Update cabal.port.mk to support .inc files
- Add logic to include `cabal-manifest.inc` if it exists
- Test with one sample port

### Step 2: Create migration script
- Extract manifest data
- Generate .inc files
- Test on all 13 ports

### Step 3: Migrate all ports to .inc format
- Run migration script on each port
- Test each port builds correctly
- Commit changes

### Step 4: Create update automation script
- Implement version checking
- Implement cabal-bundler integration
- Implement makesum update
- Test on sample ports

### Step 5: Create batch update tool
- Implement iteration logic
- Implement reporting
- Add git integration

### Step 6: Documentation
- Update devel/cabal README with new workflow
- Document automation tools usage
- Add examples

## Technical Details

### Hackage API for Version Checking
```
https://hackage.haskell.org/package/<package>/preferred
```
Returns JSON with latest preferred version.

### Preserving cabal-bundler Commands
The first line of `cabal-manifest.inc` will be:
```makefile
# Generated by: cabal-bundler --openbsd package-version [--flags] [--executable exe]
```

This ensures reproducibility and documents complex invocations.

### Backward Compatibility
During transition, both formats are supported:
- Old: MODCABAL_MANIFEST in Makefile
- New: .include "cabal-manifest.inc" in Makefile

### Error Handling
Automation will detect and report:
- Cabal-bundler failures
- checksum update failures
- Build failures
- Patch application failures
- PLIST mismatches

User must manually resolve these cases.

## Expected Outcomes

1. **Cleaner Makefiles**: Large manifests moved to .inc files
2. **Easy Updates**: Single command to update a port
3. **Batch Updates**: Update all cabal ports at once
4. **Local Validation**: User retains full control over testing
5. **Reproducible**: cabal-bundler commands preserved in .inc files
6. **Maintainable**: Follows OpenBSD ports conventions
